<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>WebGIS ایران - پروژه‌های مدرسه‌سازی</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100vh; }
        
        .info-panel {
            width: 380px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 500;
        }
        .panel-header {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #3498db;
        }
        .panel-header h1 { font-size: 1.5em; margin-bottom: 5px; color: #ecf0f1; }
        .panel-header p { opacity: 0.9; font-size: 0.95em; color: #bdc3c7; }
        .panel-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        .province-info, .project-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 15px;
            border-right: 5px solid #e74c3c;
        }
        .project-info h3 {
            color: #f39c12;
            font-size: 1.4em;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 8px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 6px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.15);
            font-size: 0.98em;
        }
        .info-label { font-weight: bold; color: #bdc3c7; }
        .info-value { color: #ecf0f1; text-align: left; max-width: 70%; word-wrap: break-word; }

        .no-selection {
            text-align: center;
            padding: 50px 20px;
            color: #bdc3c7;
            opacity: 0.8;
        }
        .no-selection .icon { font-size: 4em; margin-bottom: 15px; }

        #map { flex: 1; }

        /* استایل اسکرول‌بار */
        .panel-content::-webkit-scrollbar { width: 8px; }
        .panel-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .panel-content::-webkit-scrollbar-thumb { background: #e74c3c; border-radius: 4px; }

        /* دکمه‌های کنترل */
        .custom-basemap-selector, .home-button {
            position: absolute; z-index: 1000; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(12px); border-radius: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-family: inherit; transition: all 0.3s ease;
        }
        .custom-basemap-selector { bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; }
        #basemapSelect { padding: 12px 30px; font-size: 15px; border: none; background: transparent; color: #2c3e50; cursor: pointer; }
        .home-button { top: 86px; left: 10px; width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .home-button:hover { background: #e74c3c; transform: scale(1.15); }
        .home-button:hover svg { fill: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="info-panel">
        <div class="panel-header">
            <h1>پروژه‌های مدرسه‌سازی ایران</h1>
            <p>کلیک روی نقاط نارنجی → جزئیات پروژه</p>
        </div>
        <div class="panel-content" id="infoPanel">
            <div class="no-selection">
                <div class="icon">مدرسه</div>
                <h3>یک پروژه را انتخاب کنید</h3>
                <p>روی نقاط نارنجی روی نقشه کلیک کنید</p>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<!-- انتخابگر لایه پایه -->
<div class="custom-basemap-selector">
    <select id="basemapSelect" onchange="changeBasemap(this.value)">
        <option value="carto">رنگارنگ (پیش‌فرض)</option>
        <option value="persiangis">نقشه فارسی</option>
        <option value="satellite">ماهواره‌ای</option>
        <option value="light">خاکستری روشن</option>
        <option value="osm">استاندارد OSM</option>
    </select>
</div>

<!-- دکمه بازگشت به ایران -->
<div class="home-button" onclick="zoomToIran()" title="نمایش کل ایران">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([32.4279, 53.6880], 6);

    let selectedLayer = null;
    let selectedCountyLayer = null;
    let selectedProjectMarker = null;
    let projectsLayer = null;  // لایه نقاط پروژه‌ها

    // آیکون سفارشی برای پروژه‌های مدرسه‌سازی
    const schoolIcon = L.divIcon({
        html: `<div style="background:#e67e22; width:14px; height:14px; border-radius:50%; border:3px solid white; box-shadow:0 0 8px rgba(0,0,0,0.6);"></div>`,
        className: 'custom-marker',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });

    // لایه‌های پایه
    const basemapLayers = {
        carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB' }),
        persiangis: L.tileLayer('https://map.persiangis.ir/tile/{z}/{x}/{y}.png', { attribution: '© PersianGIS' }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }),
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB' }),
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' })
    };
    let currentBasemap = basemapLayers.carto;
    currentBasemap.addTo(map);

    function changeBasemap(val) {
        map.removeLayer(currentBasemap);
        currentBasemap = basemapLayers[val];
        currentBasemap.addTo(map);
    }

    // بارگذاری نقاط پروژه‌ها از Projects.json
    fetch('Projects.json')
        .then(r => r.json())
        .then(data => {
            // تبدیل Esri JSON به GeoJSON استاندارد (اگر نیاز بود)
            const features = data.features || [];

            projectsLayer = L.geoJSON(features, {
                pointToLayer: (feature, latlng) => {
                    return L.marker(latlng, { icon: schoolIcon });
                },
                onEachFeature: (feature, layer) => {
                    const p = feature.attributes || feature.properties;

                    layer.on('click', () => {
                        // پاک کردن انتخاب قبلی (استان/شهرستان/پروژه)
                        if (selectedLayer) { geo.resetStyle(selectedLayer); selectedLayer = null; }
                        if (selectedCountyLayer) { countiesLayer?.resetStyle(selectedCountyLayer); selectedCountyLayer = null; }
                        if (selectedProjectMarker) { selectedProjectMarker.setIcon(schoolIcon); }

                        // برجسته کردن مارکر کلیک‌شده
                        layer.setIcon(L.divIcon({
                            html: `<div style="background:#e74c3c; width:18px; height:18px; border-radius:50%; border:4px solid white; box-shadow:0 0 12px rgba(231,76,60,0.8); animation:pulse 1.5s infinite;"></div>`,
                            className: 'custom-marker',
                            iconSize: [26, 26],
                            iconAnchor: [13, 13]
                        }));
                        selectedProjectMarker = layer;

                        // زوم نرم به نقطه
                        map.flyTo(layer.getLatLng(), 12, { duration: 1.2 });

                        // نمایش اطلاعات در پنل
                        document.getElementById('info').innerHTML = `
                            <div class="project-info">
                                <h3>${p["نام پروژه"] || 'نامشخص'}</h3>
                                <div class="info-item"><span class="info-label">کد پروژه:</span><span class="info-value">${p["کد پروژه"]}</span></div>
                                <div class="info-item"><span class="info-label">استان:</span><span class="info-value">${p["استان"]}</span></div>
                                <div class="info-item"><span class="info-label">منطقه:</span><span class="info-value">${p["منطقه"]}</span></div>
                                <div class="info-item"><span class="info-label">نوع پروژه:</span><span class="info-value">${p["نوع پروژه (نیاز)"]}</span></div>
                                <div class="info-item"><span class="info-label">تعداد کلاس:</span><span class="info-value">${p["تعداد کلاس"] || '-'</span></div>
                                <div class="info-item"><span class="info-label">زیربنا:</span><span class="info-value">${p["زیربنا"] ? Number(p["زیربنا"]).toLocaleString('fa-IR') + ' مترمربع' : '-'}</span></div>
                                <div class="info-item"><span class="info-label">وضعیت:</span><span class="info-value">${p["وضعیت راهبری پروژه"] || 'نامشخص'}</span></div>
                                <div class="info-item"><span class="info-label">مسئول پروژه:</span><span class="info-value">${p["مسئول پروژه"] || '-'}</span></div>
                                <div class="info-item"><span class="info-label">تلفن مسئول:</span><span class="info-value">${p["شماره تلفن مسئول پروژه"] || '-'}</span></div>
                                ${p["آدرس کیف پول"] ? `<div class="info-item"><span class="info-label">کیف پول:</span><span class="info-value" style="font-size:0.85em; direction:ltr; text-align:right;">${p["آدرس کیف پول"]}</span></div>` : ''}
                            </div>
                        `;
                    });
                }
            }).addTo(map);
        })
        .catch(err => console.error("خطا در بارگذاری Projects.json:", err));

    // دکمه بازگشت به ایران
    function zoomToIran() {
        map.flyTo([32.4279, 53.6880], 6, { animate: true, duration: 1.5 });
        if (selectedLayer) { geo?.resetStyle(selectedLayer); selectedLayer = null; }
        if (selectedCountyLayer) { countiesLayer?.resetStyle(selectedCountyLayer); selectedCountyLayer = null; }
        if (selectedProjectMarker) { selectedProjectMarker.setIcon(schoolIcon); selectedProjectMarker = null; }

        document.getElementById('info').innerHTML = `
            <div class="no-selection">
                <div class="icon">مدرسه</div>
                <h3>یک پروژه را انتخاب کنید</h3>
                <p>روی نقاط نارنجی روی نقشه کلیک کنید</p>
            </div>
        `;
    }

    // انیمیشن پالس برای مارکر انتخاب‌شده
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.8); }
            70% { box-shadow: 0 0 0 10px rgba(231,76,60,0); }
            100% { box-shadow: 0 0 0 0 rgba(231,76,60,0); }
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>
